name: Deploy para AWS

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  TERRAFORM_BACKEND_BUCKET: ${{ secrets.TERRAFORM_BACKEND_BUCKET }}
  TF_VAR_environment: prod
  TF_VAR_aws_region: us-east-1
  TF_VAR_project_name: jaiminho-notificacoes
  TF_VAR_lambda_memory_size: 512
  TF_VAR_lambda_timeout: 60
  TF_VAR_db_instance_class: db.t4g.micro
  TF_VAR_db_allocated_storage: 20
  TF_VAR_db_max_allocated_storage: 100
  TF_VAR_db_master_username: admin
  TF_VAR_db_master_password: ${{ secrets.DB_MASTER_PASSWORD }}
  TF_VAR_wapi_api_key: ${{ secrets.WAPI_API_KEY }}
  TF_VAR_sendpulse_api_key: ${{ secrets.SENDPULSE_API_KEY }}

jobs:
  terraform:
    name: Terraform Plan & Apply
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.7.0

      - name: Debug - Verificar Secrets
        run: |
          echo "TERRAFORM_BACKEND_BUCKET: ${TERRAFORM_BACKEND_BUCKET}"
          echo "AWS_ACCESS_KEY_ID length: ${#AWS_ACCESS_KEY_ID}"
          echo "AWS_SECRET_ACCESS_KEY length: ${#AWS_SECRET_ACCESS_KEY}"

      - name: Terraform Init
        working-directory: ./terraform
        env:
          TF_LOG: DEBUG
        run: |
          if [ -z "$TERRAFORM_BACKEND_BUCKET" ]; then
            echo "ERROR: TERRAFORM_BACKEND_BUCKET está vazio!"
            echo "Verifique se a secret está configurada no GitHub"
            exit 1
          fi
          terraform init \
            -backend-config="bucket=${TERRAFORM_BACKEND_BUCKET}" \
            -backend-config="key=prod/terraform.tfstate" \
            -backend-config="region=us-east-1" \
            -backend-config="encrypt=true"

      - name: Terraform Plan
        working-directory: ./terraform
        run: terraform plan -out=tfplan

      - name: Terraform Apply
        working-directory: ./terraform
        if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
        run: terraform apply -auto-approve tfplan

      - name: Export Outputs
        working-directory: ./terraform
        run: terraform output -json > terraform-outputs.json

      - name: Upload do Código para Lambda
        run: |
          # Instalar dependências
          pip install -q -r requirements/prod.txt
          
          # Empacotar código
          zip -r lambda_code.zip src/ config/ -q
          
          # Fazer upload
          for func in jaiminho-prod-message-orchestrator jaiminho-prod-daily-digest jaiminho-prod-feedback-handler; do
            aws lambda update-function-code \
              --function-name $func \
              --zip-file fileb://lambda_code.zip \
              --region us-east-1 || echo "Função $func não existe ainda (primeira execução)"
          done

      - name: Exibir URL da API
        run: |
          echo "✅ Deploy concluído!"
          echo ""
          echo "API Gateway URL:"
          terraform -chdir=./terraform output -raw api_gateway_url 2>/dev/null || echo "Em processamento..."
